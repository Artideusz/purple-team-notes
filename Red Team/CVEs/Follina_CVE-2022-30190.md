# Follina ( CVE-2022-30190 )

Follina is a critical **RCE** exploit found inside the **Microsoft Support Diagnostic Tool**, which is invoked by payloads inside a word document. The user does not have to even open the file in order to run the exploit if the file format is of type "**.rtf**".

## Discovery

The vulnerability was first disclosed by a cybersecurity research group called [**@nao_sec**](https://twitter.com/nao_sec/status/1530196847679401984) on May 27 2022. It was found as a malicious word document sent by an Belarusian IP address. The document also contained a C2 Server located in Russia, Moscow. There are mentions that the vulnerability was disclosed back  in April 2022 by a user named [Crazyman](https://twitter.com/crazymanarmy), but I could not find the specific twitter post mentioning Follina by this user (I only found a mention [here](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190)).

The process of the malicious file can be found [here](https://app.any.run/tasks/713f05d2-fe78-4b9d-a744-f7c133e3fafb/#).

## Vulnerable versions

The patch for this vulnerability was implemented in Windows 10 Version 10.0.19044.1766 (KB5014699).

## Mitigations

If an update is not possible, a workaround is to backup and remove the registry "/HKEY_CLASSES_ROOT/ms-msdt"; these are the steps from the [Microsoft](https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/) page:

1. Open a terminal as an administrator.
2. Backup the registry with this command `reg export HKEY_CLASSES_ROOT\ms-msdt <filename>`.
3. Delete the registry with this command `reg delete HKEY_CLASSES_ROOT\ms-msdt`.

To undo the workaround:

1. Open a terminal as an administrator.
2. Import the registry with this command `reg import <filename>`.

## How does the vulnerability work?

The attack process is the following:

- Open the `.docx` file, which:
    - Contains a custom `<Relationship/>` XML object in the `word/_rels/document.xml.rels` file.
        - XML tag contains a `Type=` attribute which can be anything.
        - This XML tag contains an URL pointing to a malicious html file in the `Target=` attribute.
        - This XML tag also contains a `TypeTarget="External"` tag to enable the Word program to fetch for the resource.
- The file fetches an HTML file and loads it.
    - It contains 4096 bytes of padding (for the MSDT pin bypass?).
    - The file also contains a HTML script tag that contains a `window.location` redirect.
    - The `window.location` redirect contains a payload which uses the `ms-msdt:` protocol.
    - The `ms-msdt` payload uses the following parameters to enable Remote Code Execution: `ms-msdt:/id PCWDiagnostic /skip force /param \"POWERSHELL?\"`.
- The HTML content is loaded from the document.
- The HTML script tag invokes the Microsoft Support Diagnostic Tool and runs Powershell code OR runs a binary file available on the computer.

