# PwnKit ( CVE-2021-4034 )

CVE-2021-4034 is a severe policy toolkit (polkit) vulnerability that allows the attacker to easily escalate privilege on a linux victim machine by leveraging a out-of-bound read and write and a vulnerable function. It was discovered by researchers at Qualys and was announced in January 2022. The vulnerability existed since the creation of pkexec, in May 15 2009.

## Vulnerable versions
Polkit was vulnerable from [commit c8c3d835 "Add a pkexec(1) command"](https://gitlab.freedesktop.org/polkit/polkit/-/commit/c8c3d835d24fc4ce5a9c596c7d55d85a0311e8d1) done May 15 2009 to [commit a2bf5c9c "pkexec: local privilege escalation (CVE-2021-4034)"](https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683) done January 25 2022.

## What is polkit?
Polkit is a component for controlling security privileges in processes (similarily to sudo) and comes almost always preinstalled with the linux system.

## How does the vulnerability work?

The beginning of the `pkexec` main function first processes arguments provided by the user to get the path of the program executed. Unfortunately, arguments are not processed properly, causing an out-of-bounds read and write. The vulnerable read and write happens only when argc=0, and that causes the `path` variable in line 610 to be assigned `argv[1]`, which (done by `execve`) reads the first environment variable that is mapped right next to program arguments. We can then create our own environment variable which is written out-of-bounds with the PATH environment variable and the path variable in line 610, for example:

1. If `envp[0]` = "value"
2. And `$PATH` = "key"
3. Then the program assignes "value" to the `path` variable.
4. `g_find_program_in_path` tries to find the executable in `$PATH`.
5. If found, the full path is assigned to `envp[0]`, or `argv[1]`.

This out-of-bounds read and write allows us to create a new environment variable that is not secured in any way. This is the first half of the exploit.

The other half is exploiting a function that would use our new environment variable, and unfortunately there is `g_printerr()` which also runs `iconv_open()`, which can run shared libraries through an environment variable `GCONV_PATH`.

TODO